<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer Sandbox</title>
<style>
  body { margin:0; overflow:hidden; background:#222; font-family:sans-serif; }
  #login { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
           background:#333; padding:20px; border-radius:10px; color:white; text-align:center;}
  canvas { display:block; }
  input { padding:5px; border-radius:5px; border:none; margin-top:10px; }
  button { padding:5px 10px; border:none; border-radius:5px; margin-top:10px; cursor:pointer; }
</style>
</head>
<body>

<div id="login">
  <h2>Enter your name</h2>
  <input type="text" id="username" placeholder="Player name"/>
  <br>
  <button onclick="startGame()">Play</button>
</div>

<canvas id="gameCanvas"></canvas>

<script type="module">
// ---------------- Firebase Setup ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBKwfpfzAsg_B9FG7pi9B3XXHU6V3Qk-t8",
  authDomain: "d-sandbox-afe0f.firebaseapp.com",
  projectId: "d-sandbox-afe0f",
  storageBucket: "d-sandbox-afe0f.firebasestorage.app",
  messagingSenderId: "519011471036",
  appId: "1:519011471036:web:118b8f570cd868d7a90ab9",
  measurementId: "G-7JHJWDB3C3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------------- Canvas Setup ----------------
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ---------------- Map Setup ----------------
const tileSize = 40;
const mapWidth = 30;
const mapHeight = 20;
let map = [];

// Tiles: 0 = empty, 1 = wall, 2 = floor, 3 = hallway, 4 = vent
for(let y=0; y<mapHeight; y++){
  map[y] = [];
  for(let x=0; x<mapWidth; x++){
    map[y][x] = 1; // default wall
  }
}

// --- Rooms using old map layout ---
function createRoom(x,y,w,h,tile){
  for(let i=0;i<h;i++){
    for(let j=0;j<w;j++){
      map[y+i][x+j] = tile;
    }
  }
}

// Main room (center)
createRoom(12,7,6,6,2);

// Side rooms
createRoom(2,8,6,4,2);  // left
createRoom(22,8,6,4,2); // right
createRoom(12,15,6,4,2);// bottom

// Hallways
for(let x=8;x<12;x++) map[9][x]=3;    // left hallway
for(let x=18;x<22;x++) map[9][x]=3;   // right hallway
for(let y=13;y<15;y++) map[y][14]=3;  // bottom hallway

// Vents in hallways
map[9][11]=4;
map[9][18]=4;
map[14][14]=4;

// ---------------- Decorations ----------------
function addDecorations(){
  for(let y=0;y<mapHeight;y++){
    for(let x=0;x<mapWidth;x++){
      if(map[y][x]==2){ // room floor
        map[y][x+'decor'] = {type:'plant',color:'green'};
      }
      if(map[y][x]==4){ // vent
        map[y][x+'decor'] = {type:'vent',color:'orange'};
      }
    }
  }
}
addDecorations();

// ---------------- Player Setup ----------------
let player = {x:14, y:9, color:'cyan', name:'Player'};
let playerId = 'player_' + Math.floor(Math.random()*10000);

// Other players
let otherPlayers = {};

// ---------------- Controls ----------------
let keys = {};
document.addEventListener('keydown', e=>keys[e.key]=true);
document.addEventListener('keyup', e=>keys[e.key]=false);

// ---------------- Camera ----------------
let camera = {x:0, y:0};
function updateCamera(){
  // Center camera in main room if inside it
  if(player.x>=12 && player.x<18 && player.y>=7 && player.y<13){
    camera.x = canvas.width/2 - 14*tileSize;
    camera.y = canvas.height/2 - 9*tileSize;
  } else {
    camera.x = canvas.width/2 - player.x*tileSize;
    camera.y = canvas.height/2 - player.y*tileSize;
  }
}

// ---------------- Firebase Multiplayer ----------------
function updateFirebase(){
  set(ref(db,'players/'+playerId),{
    x: player.x,
    y: player.y,
    name: player.name
  });
}

// Listen for other players
onValue(ref(db,'players'), snapshot=>{
  otherPlayers = snapshot.val() || {};
  delete otherPlayers[playerId];
});

// ---------------- Game Loop ----------------
function gameLoop(){
  // --- Movement ---
  let dx=0, dy=0;
  if(keys['w']||keys['ArrowUp']) dy=-0.1;
  if(keys['s']||keys['ArrowDown']) dy=0.1;
  if(keys['a']||keys['ArrowLeft']) dx=-0.1;
  if(keys['d']||keys['ArrowRight']) dx=0.1;

  let newX = player.x + dx;
  let newY = player.y + dy;

  // Collision
  if(map[Math.floor(newY)][Math.floor(newX)] !=1){
    player.x = newX;
    player.y = newY;
  }

  updateCamera();
  updateFirebase();
  draw();
  requestAnimationFrame(gameLoop);
}

// ---------------- Drawing ----------------
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<mapHeight;y++){
    for(let x=0;x<mapWidth;x++){
      let tile = map[y][x];
      let screenX = x*tileSize + camera.x;
      let screenY = y*tileSize + camera.y;

      // Tiles
      switch(tile){
        case 1: ctx.fillStyle='gray'; break;
        case 2: ctx.fillStyle='lightgray'; break;
        case 3: ctx.fillStyle='darkgray'; break;
        case 4: ctx.fillStyle='gold'; break;
      }
      ctx.fillRect(screenX,screenY,tileSize,tileSize);

      // Decorations
      let decor = map[y][x+'decor'];
      if(decor){
        ctx.fillStyle = decor.color;
        ctx.fillRect(screenX+10,screenY+10,20,20);
      }
    }
  }

  // Other players
  for(let id in otherPlayers){
    const p = otherPlayers[id];
    ctx.fillStyle = 'red';
    ctx.fillRect(p.x*tileSize+camera.x,p.y*tileSize+camera.y,tileSize,tileSize);
    ctx.fillStyle = 'white';
    ctx.font = '12px sans-serif';
    ctx.fillText(p.name, p.x*tileSize+camera.x, p.y*tileSize+camera.y-5);
  }

  // Player
  ctx.fillStyle = player.color;
  ctx.fillRect(player.x*tileSize+camera.x,player.y*tileSize+camera.y,tileSize,tileSize);
  ctx.fillStyle='white';
  ctx.font='12px sans-serif';
  ctx.fillText(player.name,player.x*tileSize+camera.x,player.y*tileSize+camera.y-5);
}

// ---------------- Start Game ----------------
window.startGame = function(){
  const nameInput = document.getElementById('username');
  if(nameInput.value.trim()!=''){
    player.name = nameInput.value.trim();
    document.getElementById('login').style.display='none';
    gameLoop();
  } else {
    alert('Please enter a name');
  }
};
</script>
</body>
</html>
